<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Manual Control Game (Dynamical Systems)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#0b0f17; color:#e8eefc;}
    header { padding: 12px 16px; display:flex; gap:12px; align-items:center; border-bottom:1px solid #1c2433;}
    select, button, input[type="range"] { background:#121a2a; color:#e8eefc; border:1px solid #26324a; border-radius:10px; padding:8px 10px; }
    button { cursor:pointer; }
    main { display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 12px; padding: 12px; }
    .card { background:#0f1626; border:1px solid #1c2433; border-radius:16px; padding:12px; box-shadow: 0 10px 20px rgba(0,0,0,.25); }
    canvas { width:100%; height:320px; background:#0b0f17; border-radius:12px; border:1px solid #1c2433; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .stat { padding:8px 10px; border-radius:12px; background:#0b0f17; border:1px solid #1c2433; }
    .hint { color:#a9b7d3; font-size: 13px; line-height: 1.35; }
    .big { font-size:18px; font-weight:650; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#111a2b; border:1px solid #26324a; padding:2px 6px; border-radius:8px; }
    .bar { height:10px; background:#111a2b; border:1px solid #26324a; border-radius:999px; overflow:hidden; }
    .bar > div { height:100%; width:50%; background:#4da3ff; }
  </style>
</head>
<body>
  <header>
    <div class="big">Manual Control Game</div>
    <label>System:
      <select id="system">
        <option value="lag">1st order lag</option>
        <option value="integrator">Integrator</option>
        <option value="second">2nd order underdamped</option>
        <option value="delay">Lag + delay</option>
        <option value="unstable">Unstable 1st order</option>
      </select>
    </label>
    <button id="reset">Reset</button>
    <button id="pause">Pause</button>
    <label>Input u:
      <input id="uSlider" type="range" min="-1" max="1" step="0.01" value="0" style="width:220px"/>
    </label>
  </header>

  <main>
    <div class="card">
      <canvas id="scope" width="900" height="360"></canvas>
      <div class="row" style="margin-top:10px;">
        <div class="stat">Target r: <span id="rVal">0.00</span></div>
        <div class="stat">Output y: <span id="yVal">0.00</span></div>
        <div class="stat">Error e: <span id="eVal">0.00</span></div>
        <div class="stat">u: <span id="uVal">0.00</span></div>
        <div class="stat">Score: <span id="scoreVal">0</span></div>
      </div>
      <div style="margin-top:10px;">
        <div class="hint">
          Controls: <span class="kbd">←</span>/<span class="kbd">→</span> (or <span class="kbd">A</span>/<span class="kbd">D</span>) changes u,
          <span class="kbd">Space</span> sets u=0. Use the slider on mobile.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="big">Objective</div>
      <p class="hint">Keep <b>y(t)</b> close to <b>r(t)</b>. Your score decreases with accumulated |error|.</p>

      <div class="big" style="margin-top:12px;">Difficulty</div>
      <div class="hint">Error penalty rate</div>
      <input id="penalty" type="range" min="0.5" max="3" step="0.1" value="1.2" style="width:100%"/>

      <div class="big" style="margin-top:12px;">“Health”</div>
      <div class="bar"><div id="healthFill"></div></div>
      <p class="hint" id="sysHint" style="margin-top:10px;"></p>

      <div class="big" style="margin-top:12px;">Teaching knobs</div>
      <div class="hint">Target mode</div>
      <select id="targetMode" style="width:100%">
        <option value="steps">Random steps</option>
        <option value="sine">Sine</option>
        <option value="chirp">Chirp (hard)</option>
      </select>

      <div class="hint" style="margin-top:10px;">Noise</div>
      <input id="noise" type="range" min="0" max="0.2" step="0.01" value="0.03" style="width:100%"/>
    </div>
  </main>

<script>
(() => {
  // --- UI refs
  const canvas = document.getElementById("scope");
  const ctx = canvas.getContext("2d");
  const systemSel = document.getElementById("system");
  const resetBtn = document.getElementById("reset");
  const pauseBtn = document.getElementById("pause");
  const uSlider = document.getElementById("uSlider");
  const penaltySlider = document.getElementById("penalty");
  const noiseSlider = document.getElementById("noise");
  const targetMode = document.getElementById("targetMode");
  const sysHint = document.getElementById("sysHint");

  const rVal = document.getElementById("rVal");
  const yVal = document.getElementById("yVal");
  const eVal = document.getElementById("eVal");
  const uVal = document.getElementById("uVal");
  const scoreVal = document.getElementById("scoreVal");
  const healthFill = document.getElementById("healthFill");

  // --- Simulation state
  const dt = 1/60; // 60 Hz
  const horizon = 10; // seconds shown
  const N = Math.floor(horizon / dt);

  let paused = false;
  let t = 0;
  let u = 0;
  let score = 0;
  let health = 1.0;

  // Delay buffer for "delay" system
  const delaySec = 0.35;
  const delaySteps = Math.max(1, Math.floor(delaySec / dt));
  let uBuf = new Array(delaySteps).fill(0);

  // Plant state
  let y = 0;
  let x1 = 0, x2 = 0; // for second order
  let r = 0;
  let nextStepTime = 0;

  // History for scope
  let histR = new Array(N).fill(0);
  let histY = new Array(N).fill(0);
  let histU = new Array(N).fill(0);

  function clamp(a, lo, hi){ return Math.max(lo, Math.min(hi, a)); }
  function randn() {
    // Box-Muller
    let u1 = Math.random() || 1e-9, u2 = Math.random();
    return Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2);
  }

  function systemDescription(kind){
    switch(kind){
      case "lag": return "1st order lag: sluggish but stable. Learn anticipation and steady input.";
      case "integrator": return "Integrator: input changes the rate. Easy to drift; learn when to let go (u→0).";
      case "second": return "2nd order underdamped: springy/oscillatory. Learn timing and damping intuition.";
      case "delay": return "Lag + delay: your action appears later. Teaches lead/preview control and patience.";
      case "unstable": return "Unstable 1st order: like balancing. Must react quickly and continuously.";
    }
  }

  function resetAll(){
    t = 0; u = 0; score = 0; health = 1.0;
    y = 0; x1 = 0; x2 = 0; r = 0;
    nextStepTime = 0;
    histR.fill(0); histY.fill(0); histU.fill(0);
    uSlider.value = "0";
    uBuf = new Array(delaySteps).fill(0);
    sysHint.textContent = systemDescription(systemSel.value);
  }

  // --- Target generator
  function updateTarget(){
    const mode = targetMode.value;

    if (mode === "steps") {
      if (t >= nextStepTime) {
        r = (Math.random()*2 - 1) * 0.9;
        nextStepTime = t + 1.5 + Math.random()*1.5;
      }
    } else if (mode === "sine") {
      r = 0.8*Math.sin(2*Math.PI*0.18*t);
    } else if (mode === "chirp") {
      const f0 = 0.05, f1 = 0.7, T = 18;
      const k = (f1 - f0)/T;
      const phase = 2*Math.PI*(f0*t + 0.5*k*t*t);
      r = 0.8*Math.sin(phase);
    }
  }

  // --- Plant update
  function stepPlant(kind){
    // optional measurement noise (applied to y shown and scoring)
    const measNoise = parseFloat(noiseSlider.value);

    if (kind === "lag") {
      const tau = 0.7, K = 1.1;
      // ydot = -y/tau + K*u
      y += dt * (-y/tau + K*u);
    }
    else if (kind === "integrator") {
      const K = 1.2;
      y += dt * (K*u);
    }
    else if (kind === "second") {
      const wn = 3.2, zeta = 0.18, K = 1.0;
      // x1 = y, x2 = ydot
      const x1dot = x2;
      const x2dot = -2*zeta*wn*x2 - wn*wn*x1 + K*wn*wn*u;
      x1 += dt * x1dot;
      x2 += dt * x2dot;
      y = x1;
    }
    else if (kind === "delay") {
      const tau = 0.7, K = 1.1;
      uBuf.push(u);
      const uDelayed = uBuf.shift();
      y += dt * (-y/tau + K*uDelayed);
    }
    else if (kind === "unstable") {
      const a = 1.1, b = 1.0;
      y += dt * (a*y + b*u);
      // soft saturate so it doesn't explode to infinity
      y = clamp(y, -3.5, 3.5);
    }

    const yMeas = y + measNoise*randn();
    return yMeas;
  }

  function pushHistory(rr, yy, uu){
    histR.push(rr); histY.push(yy); histU.push(uu);
    histR.shift();  histY.shift();  histU.shift();
  }

  function drawScope(){
    const W = canvas.width, H = canvas.height;

    // background
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#0b0f17";
    ctx.fillRect(0,0,W,H);

    // grid
    ctx.globalAlpha = 0.55;
    ctx.strokeStyle = "#1c2433";
    ctx.lineWidth = 1;
    for (let i=1;i<6;i++){
      const x = i*W/6;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    }
    for (let i=1;i<4;i++){
      const y = i*H/4;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // map value -> y pixel
    const yMin = -1.4, yMax = 1.4;
    const toY = v => H - (v - yMin) / (yMax - yMin) * H;
    const toX = i => i/(N-1)*W;

    function plot(arr, color){
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i=0;i<arr.length;i++){
        const x = toX(i), yy = toY(arr[i]);
        if (i===0) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
      }
      ctx.stroke();
    }

    // target (bright)
    plot(histR, "#e8eefc");
    // output (blue)
    plot(histY, "#4da3ff");

    // input indicator at bottom
    ctx.strokeStyle = "#7ee787";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<histU.length;i++){
      const x = toX(i);
      const uu = histU[i];
      const yy = H - 10 - (uu+1)/2 * 60; // 60px band at bottom
      if (i===0) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
    }
    ctx.stroke();

    // labels
    ctx.fillStyle = "#a9b7d3";
    ctx.font = "14px system-ui";
    ctx.fillText("r(t) (white)  y(t) (blue)   u(t) (green)", 12, 22);
  }

  function updateHUD(rr, yy, uu){
    const e = rr - yy;
    rVal.textContent = rr.toFixed(2);
    yVal.textContent = yy.toFixed(2);
    eVal.textContent = e.toFixed(2);
    uVal.textContent = uu.toFixed(2);
    scoreVal.textContent = Math.round(score).toString();
    healthFill.style.width = `${Math.round(health*100)}%`;
  }

  function tick(){
    if (!paused){
      t += dt;

      // target
      updateTarget();

      // plant step
      const yMeas = stepPlant(systemSel.value);

      // scoring
      const penalty = parseFloat(penaltySlider.value);
      const e = r - yMeas;
      score -= penalty * Math.abs(e);
      health = clamp(health - (dt*0.10*penalty*Math.abs(e)), 0, 1);

      // history
      pushHistory(r, yMeas, u);

      // UI
      drawScope();
      updateHUD(r, yMeas, u);

      // fail state
      if (health <= 0){
        paused = true;
        pauseBtn.textContent = "Resume";
      }
    }
    requestAnimationFrame(tick);
  }

  // --- Input handling
  let keyLeft=false, keyRight=false;

  function applyKeys(){
    const rate = 1.8; // how fast u changes
    if (keyLeft) u -= rate*dt;
    if (keyRight) u += rate*dt;
    u = clamp(u, -1, 1);
    uSlider.value = u.toFixed(2);
  }

  window.addEventListener("keydown", (ev) => {
    if (ev.key === "ArrowLeft" || ev.key.toLowerCase() === "a") keyLeft = true;
    if (ev.key === "ArrowRight" || ev.key.toLowerCase() === "d") keyRight = true;
    if (ev.key === " ") { u = 0; uSlider.value = "0"; }
  });
  window.addEventListener("keyup", (ev) => {
    if (ev.key === "ArrowLeft" || ev.key.toLowerCase() === "a") keyLeft = false;
    if (ev.key === "ArrowRight" || ev.key.toLowerCase() === "d") keyRight = false;
  });

  uSlider.addEventListener("input", () => {
    u = parseFloat(uSlider.value);
  });

  // update u each frame (key-based)
  function keyLoop(){
    if (!paused) applyKeys();
    requestAnimationFrame(keyLoop);
  }

  // Buttons / selectors
  resetBtn.addEventListener("click", resetAll);
  pauseBtn.addEventListener("click", () => {
    paused = !paused;
    pauseBtn.textContent = paused ? "Resume" : "Pause";
  });
  systemSel.addEventListener("change", () => {
    sysHint.textContent = systemDescription(systemSel.value);
    resetAll();
  });

  // init
  resetAll();
  keyLoop();
  tick();
})();
</script>
</body>
</html>